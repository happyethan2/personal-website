---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";
import RecipeTile from "@/components/RecipeTile.astro";

const { pathname, searchParams } = Astro.url;
const q = (searchParams.get("q") ?? "").trim().toLowerCase();

const recipes = (await getCollection("recipes", ({ data }) => !data.draft)).sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

const filtered = q
  ? recipes.filter((recipe) => recipe.data.title.toLowerCase().includes(q))
  : recipes;

const total = recipes.length;
---
<Base title="Recipes - Ethan Colgan" description="Keto-friendly recipes that taste delicious!">
  <section class="py-8 space-y-8">
    <header class="rounded-xl border border-slate-800 bg-slate-900/40 p-6">
      <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
        <div class="space-y-4">
          <p class="text-sm font-semibold uppercase tracking-wide text-blue-300/80">Recipes</p>
          <h1 class="text-3xl font-semibold text-slate-100">Ketogenic Recipes</h1>
          <p class="text-slate-300 max-w-2xl">
            Keto-friendly meals I would love to cook again!
          </p>
          <p class="text-xs uppercase tracking-wide text-slate-500">{total} recipes and counting.</p>
        </div>
        <form method="GET" action={pathname} class="w-full max-w-xs">
          <label class="block text-xs uppercase tracking-wide text-slate-500 mb-2" for="recipe-search">
            Search recipes
          </label>
          <input
            id="recipe-search"
            type="search"
            name="q"
            value={q}
            placeholder="Try butter chicken..."
            class="w-full rounded border border-slate-800 bg-slate-900 px-3 py-2 text-sm placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-cyan-500"
          />
        </form>

        <script is:inline>
          (() => {
            const script = document.currentScript;
            const form = script.previousElementSibling;
            async function init() {
              if (!form) return;
              if (document.readyState === 'loading') {
                await new Promise((r) => document.addEventListener('DOMContentLoaded', r, { once: true }));
              }
              const list = document.getElementById('items');
              const status = document.getElementById('recipes-status');
              if (!list || !status) return;

              const debounce = (fn, ms = 250) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

              async function updateList() {
                const url = new URL(location.href);
                const fd = new FormData(form);
                url.search = new URLSearchParams(fd).toString();
                list.setAttribute('aria-busy', 'true');
                const res = await fetch(url.toString(), { credentials: 'same-origin' });
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const freshList = doc.getElementById('items');
                const freshStatus = doc.getElementById('recipes-status');
                if (freshList && freshStatus) {
                  list.innerHTML = freshList.innerHTML;
                  status.textContent = freshStatus.textContent;
                  history.replaceState(null, '', url);
                }
                list.removeAttribute('aria-busy');
              }

              const debounced = debounce(updateList, 250);
              form.addEventListener('input', (e) => {
                const el = e.target; if (el && el.tagName === 'INPUT') debounced();
              }, { passive: true });
              form.addEventListener('search', updateList);
              form.addEventListener('submit', (e) => { e.preventDefault(); updateList(); });
            }
            init();
          })();
        </script>
      </div>
    </header>

    <div id="recipes-status" class="text-sm text-slate-400">
      {filtered.length === total
        ? `Showing all ${total} recipes.`
        : filtered.length === 0
          ? q
            ? `No recipes found for "${q}".`
            : "No recipes yet."
          : `Showing ${filtered.length} of ${total} recipes${q ? ` for "${q}".` : "."}`}
    </div>

    {filtered.length === 0 ? (
      <p class="text-slate-400 text-sm">Nothing matched that search just yet.</p>
    ) : (
      <div id="items" class="grid grid-cols-1 gap-3">
        {filtered.map(({ slug, data }) => (
          <RecipeTile
            href={`/recipes/${slug}`}
            title={data.title}
            kcal={data.calories_kcal}
            fat_g={data.fat_g}
            protein_g={data.protein_g}
            carbs_g={data.carbs_g}
          />
        ))}
      </div>
    )}
  </section>
</Base>